<h2>Форма обратной связи</h2>
<?php 
function arrayform($bakform){
	$i=0;
	foreach($bakform as $v=>$k) {
		$bakform[$i]=array($k[0],$k[1],$v,$k[3]);
		unset($bakform[$v]);
		$i++;
	}
	return $bakform;
}
function arrayformbk($bakform){
		foreach($bakform as $v=>$k) {
				$bakform[$k[2]]=$bakform[$v];
				unset($bakform[$k[2]][2]);
				unset($bakform[$v]);
		}
	return $bakform;
}
if(file_exists($_POST['datadir'].'/.bakform.conf')) {
	$bakform = unserialize(file_get_contents($_POST['datadir'].'/.bakform.conf'));
} else {
	$bakform = array('name' => array('Имя', 0, 3 => ''),'mail' => array('Email', 0, 3 => ''),'text' => array('Текст сообщения', 1, 3 => ''));
}
if (isset($_SESSION['adm']) || !trim($_s['pass'])) {
	if(isset($_POST['save'])) {
		foreach($_POST['bf'] as $k=>$v) { 
			if(empty($v[0])) unset($_POST['bf'][$k]);
		}
		$bakform=arrayformbk($_POST['bf']);
		fsave($_POST['datadir'].'/.bakform.conf', 'w+', serialize($bakform));
	}
	$bakform=arrayform($bakform);
	echo '<style>#bakformadd input {margin:0;}</style><form action="" method="post"><table id="bakformadd"><tr><th>Описание элемента</th><th>Тип</th><th>Название латиницей без пробелов</th><th>Значения</th></tr>';
	$i=0;
	foreach($bakform as $k=>$v) {
		echo  '
		<tr>
			<td>
				<input name="bf['.$i.'][0]" type="text" value="'.$v[0].'">
			</td>
			<td>
				<select name="bf['.$i.'][1]">'; ?>
					<option <?php if($v[1]==0)echo 'selected'; ?> value="0">text</option>
					<option <?php if($v[1]==1)echo 'selected'; ?> value="1">textarea</option>
					<option <?php if($v[1]==2)echo 'selected'; ?> value="2">select</option>
					<option <?php if($v[1]==3)echo 'selected'; ?> value="3">checkbox</option>
					<option <?php if($v[1]==4)echo 'selected'; ?> value="4">radio</option>
		<?php echo '
				</select>
			</td>
			<td>
				<input name="bf['.$i.'][2]" type="text" value="'.$v[2].'">
			</td>
			<td>
				<input name="bf['.$i.'][3]" type="text" value="'.$v[3].'">
			</td>
		</tr>';
		$i++;
	}
	echo  '
		<tr>
			<td>
				<input name="bf['.$i.'][0]" type="text" value="">
			</td>
			<td>
				<select name="bf['.$i.'][1]">
					<option value="0">text</option>
					<option value="1">textarea</option>
					<option value="2">select</option>
					<option value="3">checkbox</option>
					<option  value="4">radio</option>
				</select>
			</td>
			<td>
				<input name="bf['.$i.'][2]" type="text" value="">
			</td>
			<td>
				<input name="bf['.$i.'][3]" type="text" value="">
			</td>
		</tr>';
	echo '</table>
	<input name="save" type="hidden" value="on" /><input type="submit" />
	</form>';
	
} else{
	$bakform=arrayform($bakform);
}
if(!isset($_POST['send'])){

?>
<form action="" method="post">
<dl id="bakform">
<?php
foreach($bakform as $v) {
	$k=$v[2];
	if($v[1]==1) {
		echo '<dt class="'.$k.'">'.$v[0].'</dt><dd class="'.$k.'"><textarea name="'.$k.'" type="text">'.$v[3].'</textarea></dd>';
	}
	elseif($v[1]==2) {
		echo '<dt class="'.$k.'">'.$v[0].'</dt><dd class="'.$k.'"><select name="'.$k.'">';
			$txt=explode(',',$v[3]);
			foreach($txt as $txt) {
				echo '<option value="'.$txt.'">'.$txt.'</option>';
			}
		echo '</select></dd>';
	}
	elseif($v[1]==3) {
		echo '<dt class="'.$k.'">'.$v[0].'</dt><dd class="'.$k.'">';
			$txt=explode(',',$v[3]);
			foreach($txt as $ktxt=>$txt) {
				echo '<input type="checkbox" name="'.$k.'['.$ktxt.']'.'" value="'.$txt.'">'.$txt.'<br>';
			}
			$txt='';
		echo '</select></dd>';
	}
	elseif($v[1]==4) {
		echo '<dt class="'.$k.'">'.$v[0].'</dt><dd class="'.$k.'">';
			$txt=explode(',',$v[3]);
			foreach($txt as $txt) {
				echo '<input type="radio" name="'.$k.'" value="'.$txt.'">'.$txt.'<br>';
			}
		echo '</select></dd>';
	}
	else {
		echo '<dt class="'.$k.'">'.$v[0].'</dt><dd class="'.$k.'"><input name="'.$k.'" type="text" value="'.$v[3].'"></dd>';
	}
}
?>
</dl>
<script>
	document.write('<i');
	document.write('nput type="text" id="<?php echo $_v['ver']; ?>"');
	document.write(' name="<?php echo md5($_s['pass'] + $_v['ver']); ?>" ');
	document.write('value="<?php echo time(); ?>">');
	document.getElementById('<?php echo $_v['ver']; ?>').style.display = 'none';
</script>
<input name="send" type="hidden" value="on" /><input type="submit" />
</form>
<?php
} //send if(!isset($_POST['send']))
else {
	$bakform=arrayformbk($bakform);
	$send=$_POST;
	$txt='';
	$uniq = md5($_s['pass'] + $_v['ver']); // защита
	unset($send[$uniq]);
	unset($send['send']);
	unset($send['datadir']);
	foreach($send as $v => $k){
		if (!trim($_v[$uniq])){$err = 2;}
		if(gettype($k) == 'array') {
			foreach($k as $ktxt) { $txt = $txt.','.$ktxt; }
			$k=$txt;
			unset($txt);
		} else {
			if($v == 'mail' && !preg_match("/^[_\.0-9a-zA-Z-]+@([0-9a-zA-Z][0-9a-zA-Z-]+\.)+[a-zA-Z]{2,6}$/i",$k)) { $err = "Некоректный email"; }
			
		}
		$txt .= $bakform[$v][0].': '.$k.'<br>';
	}
	if(!isset($err)){
		if(isset($send['name'])) { $sender=$send['name'];} else { $sender=$_s['bname'];}
		if(isset($send['mail'])) { $mail=$send['mail'];} else { $mail='';}
		echo  '<script>var notify_msg = " Сообщение успешно отправлено ";</script>';
?>
	<dl class="cmt author">
		<dt><b>Сообщение успешно отправлено</b></dt>
		<dd>
			<p>
				<?php 
					if($_s['avatar']) echo '<img src="http://gravatar.com/avatar/'.md5($mail).'?s=35" id=ava>'; 
					echo $txt; 
				?>
			</p>
		</dd>
	</dl>
<?php

		echo $txt;
		@mail($_s['email'], '','');
	} else {
		echo "<b>".$err."</b><br>";
		echo '<script>var notify_msg = "' . $err . '";</script>';
	}
}
?>
